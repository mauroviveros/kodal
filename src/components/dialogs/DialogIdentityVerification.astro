---
import type { Database } from '@lib/database';
import { Icon } from 'astro-icon/components';
import type { HTMLAttributes } from 'astro/types';
import { Dialog } from '@components/ui';
import { actions } from 'astro:actions';

interface Props extends HTMLAttributes<'dialog'> {
  pet: Database['public']['Tables']['pets']['Row'];
  medal: Database['public']['Tables']['medals']['Row'];
}
const { pet, medal, class: className, ...props } = Astro.props;
const id = `dialog-identity-verification-${pet.id}`;
const initial = pet.name?.trim()?.[0]?.toUpperCase() ?? 'M';
---

<button id={`${id}-btn`} type="button" class="btn btn-filled btn-md">
  <Icon name="lucide:mail" class="size-4" />
</button>

<Dialog
  title="Verificación de Identidad"
  description="Para proteger la información de tu mascota, necesitamos verificar tu identidad."
  id={id}
  closedby="any"
  class={className}
  {...props}
>
  <form
    id={`${id}-form`}
    action={actions.sendTokenEmail}
    method="POST"
    class="bg-muted/40 rounded-xl border p-4"
  >
    <input type="hidden" name="pet" value={JSON.stringify(pet)} />
    <input type="hidden" name="medal" value={JSON.stringify(medal)} />

    <div class="flex items-center gap-3">
      <div
        class="bg-primary/10 text-primary flex size-12 items-center justify-center rounded-full font-semibold"
      >
        {initial}
      </div>
      <div class="flex flex-col">
        <span class="text-on-background text-sm font-semibold">{pet.name}</span>
        <span class="text-on-muted text-sm">{pet.breed}</span>
      </div>
    </div>

    <p class="text-on-muted mt-4 text-sm">
      Enviaremos un código de verificación al email registrado:
    </p>
    <p class="text-on-background mt-1 text-sm font-semibold">{medal.email}</p>
  </form>

  <p class="text-on-muted text-sm">
    El código expirará en 15 minutos. Haz clic en el botón del email para acceder directamente a la
    edición.
  </p>

  <div class="flex flex-col-reverse gap-2 sm:flex-row sm:justify-end" slot="footer">
    <button type="button" class="btn btn-outline btn-lg" data-dialog-close>Cancelar</button>
    <button type="submit" form={`${id}-form`} class="btn btn-filled btn-lg">
      <Icon name="lucide:mail" class="size-4" />
      Enviar Código
    </button>
  </div>
</Dialog>
