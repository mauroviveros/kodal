---
import { Icon } from 'astro-icon/components';
---

<button id={`dialog-add-medals-btn`} type="button" class="btn btn-filled btn-md">
  <Icon name="lucide:plus" class="size-4" />
  Crear medallas
</button>

<dialog id="dialog-add-medals" closedby="any">
  <header class="dialog-header">
    <h2 class="dialog-title">Crear Medallas Nuevas</h2>
    <p class="dialog-description">
      Especifica la cantidad de medallas que deseas crear (m√°ximo 100)
    </p>
  </header>

  <form id="dialog-add-medals-form" class="dialog-content">
    <fieldset>
      <label for="quantity" class="text-sm">Cantidad</label>
      <input
        type="number"
        name="quantity"
        value="1"
        min="1"
        max="100"
        class="input w-full"
        required
      />
    </fieldset>

    <button type="submit" class="btn btn-lg btn-filled">Crear medallas</button>
  </form>
</dialog>

<script>
  import { actions } from 'astro:actions';

  const dialog = document.getElementById('dialog-add-medals') as HTMLDialogElement;
  const openBtn = document.getElementById('dialog-add-medals-btn') as HTMLButtonElement;
  const form = document.getElementById('dialog-add-medals-form') as HTMLFormElement;
  const submitBtn = form.querySelector('button[type="submit"]') as HTMLButtonElement;

  openBtn?.addEventListener('click', () => {
    dialog?.showModal();
  });

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();

    const quantity = parseInt(form.quantity.value);

    submitBtn.disabled = true;
    submitBtn.innerText = 'Creando...';

    try {
      const result = await actions.createBulkMedals({ quantity });
      if (result.error) throw result.error;

      if (result.data.medals) {
        dialog.close();
        window.location.reload();
      }
    } catch (error) {
      console.error('Error creating medals:', error);
      submitBtn.disabled = false;
      submitBtn.innerText = 'Crear medallas';
    }
  });
</script>
