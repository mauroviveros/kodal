---
import Layout from '@layout';
import { DialogAddMedals, DialogDetailMedal } from '@components/dialogs';
import { Icon } from 'astro-icon/components';
import { Pagination } from '@components/common';
import { actions } from 'astro:actions';
import { Button, Card, Table } from '@components/ui';
import { MEDAL_STATUS } from '@constants';
import { generateQR } from '@utils';

const { data: response, error } = await Astro.callAction(actions.getMedalsPaginated, {
  page: parseInt(Astro.params.page || '1'),
  pageSize: 100,
});

if (error) return Astro.rewrite('/404');
const { data, pagination } = response;
---

<Layout showFooter={false} title="Kodal - Panel de Administración">
  <div>
    <h1 class="text-primary text-2xl font-bold">Panel de Administración</h1>
    <p class="text-on-muted text-sm">Gestión de Medallas Inteligentes</p>
  </div>

  <section class="flex flex-col gap-2">
    <Card class="flex-end items-end justify-center px-6">
      <DialogAddMedals />
    </Card>
    <Card class="overflow-x-auto">
      <Table>
        <thead>
          <tr>
            <th align="left">Mascota</th>
            <th align="left">Dueño</th>
            <th align="left">Correo</th>
            <th align="right">Fecha ultima actualización</th>
            <th align="right">Fecha de creación</th>
            <th align="center">Estado</th>
            <th align="center">Acciones</th>
          </tr>
        </thead>
        <tbody>
          {
            data.map(async (medal) => {
              const QRbase64 = await generateQR(new URL(`/medal/${medal.id}`, Astro.url.origin));
              const status = MEDAL_STATUS[medal.status];
              return (
                <tr>
                  <td align="left">{medal.pets?.name}</td>
                  <td align="left">{medal.full_name}</td>
                  <td align="left">{medal.email}</td>
                  <td align="right">{medal.pets?.updated_at ? new Date(medal.pets.updated_at).toLocaleString() : ''}</td>
                  <td align="right">{medal.pets?.created_at ? new Date(medal.pets.created_at).toLocaleString() : ''}</td>
                  <td align="center">
                    <span class:list={['badge border', status.class]}>
                      <Icon name={status.icon} />
                      {status.text}
                    </span>
                  </td>

                  <td align="center" class="space-x-2">
                    <DialogDetailMedal medal={medal} QRbase64={QRbase64} />

                    <Button href={QRbase64} variant="ghost" size="sm" download={`${medal.id}.png`}>
                      <Icon name="lucide:download" />
                    </Button>
                  </td>
                </tr>
              );
            })
          }
        </tbody>
      </Table>
    </Card>

    <Card>
      <Pagination origin="/admin/medals" pagination={pagination} class="py-0!" />
    </Card>
  </section>
</Layout>
