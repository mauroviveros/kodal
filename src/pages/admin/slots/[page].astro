---
import QRCode from 'qrcode';
import Layout from '@layout';
import { AddSlotsDialog, ViewSlotDialog } from '@components/dialogs';
import { getSlotsPaginated } from '@lib/services/slots';
import { Icon } from 'astro-icon/components';
import Pagination from '@components/ui/Pagination.astro';

enum Status {
  ACTIVE = 'Activo',
  INACTIVE = 'Inactivo',
}
const { locals, params } = Astro;
const { data, ...pagination } = await getSlotsPaginated(locals.supabase)(
  parseInt(params.page || '1'),
  10,
);

const getStatus = (medal_id: string): Status => {
  return medal_id ? Status.ACTIVE : Status.INACTIVE;
};

const getDate = (date: string): string => {
  return Intl.DateTimeFormat(undefined, { dateStyle: 'short', timeStyle: 'short' }).format(
    new Date(date),
  );
};

const getSlotQR = async (id: string) => {
  const QR = await QRCode.toDataURL(new URL(`/medal/${id}`, Astro.url.origin).toString(), {
    margin: 1,
  });

  return QR;
};
---

<Layout showFooter={false} title="Kodal - Panel de Administración">
  <div>
    <h1 class="text-primary text-2xl font-bold">Panel de Administración</h1>
    <p class="text-on-muted text-sm">Gestión de Medallas Inteligentes</p>
  </div>

  <section class="flex flex-col gap-2">
    <header class="card flex-row items-center justify-end px-6">
      <AddSlotsDialog />
    </header>

    <article class="card overflow-x-auto">
      <table class="table-auto">
        <thead>
          <tr>
            <th>ID</th>
            <th>Fecha creacion</th>
            <th>Estado</th>
          </tr>
        </thead>
        <tbody>
          {
            data.map(async (slot) => {
              const QRbase64 = await getSlotQR(slot.id);
              return (
                <tr>
                  <td class="truncate">{slot.id}</td>
                  <td>{getDate(slot.created_at)}</td>
                  <td>
                    {slot.medal_id ? (
                      <span class="badge border-emerald-300 bg-emerald-100 text-emerald-700">
                        <Icon name="lucide:user-check" />
                        EN USO
                      </span>
                    ) : (
                      <span class="badge border-blue-300 bg-blue-100 text-blue-700">
                        <Icon name="lucide:sparkles" />
                        NUEVO
                      </span>
                    )}
                  </td>
                  <td>
                    <div class="flex items-center justify-end gap-2">
                      <ViewSlotDialog medalSlot={slot} QRbase64={QRbase64} />

                      <a href={QRbase64} class="btn btn-sm" download={`${slot.id}.png`}>
                        <Icon name="lucide:download" class="size-4" />
                      </a>
                    </div>
                  </td>
                </tr>
              );
            })
          }
        </tbody>
      </table>
    </article>

    <footer class="card">
      <Pagination origin="/admin/slots" pagination={pagination} />
    </footer>
  </section>
</Layout>
